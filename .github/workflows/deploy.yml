name: Deploy to Kubernetes

on:
  push:
    branches:
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: 'Set up Cloud SDK'
        uses: 'google-github-actions/setup-gcloud@v1'

      - name: Set up kubectl
        run: |
          curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
          chmod +x kubectl
          sudo mv kubectl /usr/local/bin/
          sudo ln -s /usr/local/bin/kubectl /usr/local/bin/gke-gcloud-auth-plugin

      - id: 'auth'
        name: 'Authenticate to Google Cloud'
        uses: 'google-github-actions/auth@v1'
        with:
          credentials_json: '${{ secrets.GCP_SA_KEY }}'

      - id: 'get-credentials'
        uses: 'google-github-actions/get-gke-credentials@v1'
        with:
          cluster_name: 'go-application-cluster'
          location: 'europe-west1'
      #- name: Configure Google Cloud credentials
      #  uses: google-github-actions/auth@v0.6.0
      #  with:
      #    service_account_key: ${{ secrets.GCP_SA_KEY }}
      #    export_default_credentials: true

      #- name: Configure Google Cloud credentials
      #  uses: google-github-actions/auth@1.1.1
      #  with:
      #    credentials_json: ${{ secrets.GCP_SA_KEY }}
      

      - name: Get cluster credentials
        run: gcloud container clusters get-credentials go-application-cluster --region europe-west1 --project silver-tape-392620

      - name: Verify cluster info
        run: kubectl version

      #- name: Verify cluster info
      #  run: |
      #    kubectl version

      #- name: Build and push Docker image
      #  run: |
      #    gcloud auth configure-docker europe-west1-docker.pkg.dev
      #    docker build -t europe-west1-docker.pkg.dev/silver-tape-392620/astrafydocker/astrafygov1:${{ github.sha }} .
      #    docker push europe-west1-docker.pkg.dev/silver-tape-392620/astrafydocker/astrafygov1:${{ github.sha }}
#
      #- name: Set image URL environment variable
      #  run: echo "IMAGE_URL=europe-west1-docker.pkg.dev/silver-tape-392620/astrafydocker/astrafygov1:${{ github.sha }}" >> $GITHUB_ENV
#
      #- name: Apply Kubernetes configuration
      #  run: |
      #    kubectl apply -f Kubernetes/deployment.yaml
      #    kubectl apply -f Kubernetes/service.yaml